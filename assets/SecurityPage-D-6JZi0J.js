import{b as F,r as s,j as e,y as R,a2 as T,a6 as I,z as M,P as Y,aJ as Q}from"./main-Caen3FYs.js";import*as U from"https://esm.sh/qrcode@1.5.3";import"./react-Ckhrjn13.js";const O=a=>{const x="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";let r=0,c=0,d="";for(let o=0;o<a.length;o++)for(c=c<<8|a[o],r+=8;r>=5;)d+=x[c>>>r-5&31],r-=5;return r>0&&(d+=x[c<<5-r&31]),d},V=({isOpen:a,onClose:x})=>{const{user:r,updateTwoFactorStatus:c}=F(),[d,o]=s.useState(1),[m,C]=s.useState(""),[u,S]=s.useState(""),[g,h]=s.useState(""),[b,i]=s.useState(""),[y,p]=s.useState(!1),l=()=>{if(r?.username){const n=new Uint8Array(20);window.crypto.getRandomValues(n);const k=O(n);C(k);const j=`otpauth://totp/iLovePDFLY:${r.username}?secret=${k}&issuer=iLovePDFLY`;U.toDataURL(j,(f,N)=>{f?(console.error(f),i("Could not generate QR code. Please try again.")):S(N)})}};s.useEffect(()=>{a&&(o(1),i(""),h(""),l())},[a,r]);const w=async()=>{if(g.length!==6||!/^\d{6}$/.test(g)){i("Please enter a valid 6-digit code.");return}p(!0),i("");try{await c(!0),o(3)}catch(n){i(n.message||"An error occurred. Please try again."),p(!1)}};return a?e.jsx("div",{className:"fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4",onClick:x,children:e.jsx("div",{className:"bg-white dark:bg-black w-full max-w-lg rounded-lg shadow-xl",onClick:n=>n.stopPropagation(),children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-center mb-4",children:"Set up Two-Factor Authentication"}),d===1&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"1. Scan this QR code with your authenticator app (like Google Authenticator)."}),u?e.jsx("img",{src:u,alt:"2FA QR Code",className:"mx-auto border-4 border-white dark:border-black rounded-lg"}):e.jsx("div",{className:"w-48 h-48 bg-gray-200 animate-pulse mx-auto"}),e.jsx("p",{className:"text-xs text-gray-500 mt-4",children:"Can't scan? Enter this code manually:"}),e.jsx("code",{className:"block mt-1 p-2 bg-gray-100 dark:bg-gray-800 rounded-md font-mono",children:m}),e.jsx("button",{onClick:()=>o(2),className:"mt-6 w-full bg-brand-red hover:bg-brand-red-dark text-white font-bold py-2 px-4 rounded-md",children:"Next Step"})]}),d===2&&e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"2. Enter the 6-digit code from your authenticator app to verify."}),e.jsx("input",{type:"text",value:g,onChange:n=>h(n.target.value),maxLength:6,placeholder:"123456",className:"w-48 p-2 text-2xl tracking-[0.5em] text-center border-2 border-gray-300 rounded-md"}),b&&e.jsx("p",{className:"mt-2 text-sm text-red-500",children:b}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:()=>o(1),className:"flex-1 bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-md",children:"Back"}),e.jsx("button",{onClick:w,disabled:y,className:"flex-1 bg-brand-red hover:bg-brand-red-dark text-white font-bold py-2 px-4 rounded-md disabled:bg-red-300",children:y?"Verifying...":"Verify & Enable"})]})]}),d===3&&e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 dark:bg-green-900/50 mb-6",children:e.jsx(R,{className:"h-10 w-10 text-green-600 dark:text-green-400"})}),e.jsx("h3",{className:"text-xl font-bold",children:"Success!"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mt-2",children:"Two-Factor Authentication has been enabled on your account."}),e.jsx("button",{onClick:x,className:"mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md",children:"Done"})]})]})})}):null},W=()=>{const{user:a,auth:x,updateTwoFactorStatus:r}=F(),{isWebAuthnSupported:c,register:d}=T(),[o,m]=s.useState([]),[C,u]=s.useState(!1),[S,g]=s.useState(!1),[h,b]=s.useState(!1),[i,y]=s.useState(!1),[p,l]=s.useState(""),[w,n]=s.useState(""),[k,j]=s.useState(!0),f=x.currentUser?.providerData.some(t=>t.providerId==="password"),N=async()=>{if(a){j(!0);try{const t=await fetch("/api/passkey/credentials");if(!t.ok){console.warn("Could not fetch credentials. Backend endpoint may not be implemented."),m([]);return}const v=await t.json();m(v)}catch(t){console.error("Failed to fetch credentials:",t)}finally{j(!1)}}};s.useEffect(()=>{N()},[a]);const A=async()=>{if(window.confirm("Are you sure you want to disable Two-Factor Authentication? This will reduce your account's security.")){b(!0),l("");try{await r(!1)}catch(t){l(t.message||"Failed to disable 2FA.")}finally{b(!1)}}},P=async()=>{if(!a||!a.username){l("You must be logged in with a valid email to register a passkey.");return}y(!0),l(""),n("");try{await d(a.username),n("New passkey added successfully!"),await N()}catch(t){l(t.message||"Failed to register passkey.")}finally{y(!1)}},E=async t=>{if(window.confirm("Are you sure you want to remove this passkey? You will no longer be able to sign in with it.")){l("");try{if(!(await fetch(`/api/passkey/credentials/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to remove passkey from server.");m(D=>D.filter(L=>L.id!==t))}catch(v){l(v.message||"Could not remove passkey.")}}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"w-full space-y-8",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-extrabold text-gray-800 dark:text-gray-100",children:"Security"}),p&&e.jsx("p",{className:"mb-4 text-center text-sm text-red-500 bg-red-100 dark:bg-red-900/30 p-3 rounded-md",children:p}),w&&e.jsx("p",{className:"mb-4 text-center text-sm text-green-600 bg-green-100 dark:bg-green-900/30 p-3 rounded-md",children:w}),e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100 mb-4",children:"Passkeys"}),c?e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm mb-4",children:"Manage the passkeys (Face ID, fingerprint, security keys) used for passwordless sign-in."}),e.jsx("ul",{className:"space-y-3 mb-4",children:k?e.jsx("p",{className:"text-sm text-gray-500",children:"Loading passkeys..."}):o.map(t=>e.jsxs("li",{className:"flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-800/50 rounded-md",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(I,{className:"h-6 w-6 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-sm",children:t.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Added: ",new Date(t.createdAt).toLocaleDateString()]})]})]}),e.jsx("button",{onClick:()=>E(t.id),className:"p-2 text-gray-400 hover:text-red-500",title:"Remove Passkey",children:e.jsx(M,{className:"h-5 w-5"})})]},t.id))}),e.jsxs("button",{onClick:P,disabled:i,className:"flex items-center gap-2 text-sm font-semibold bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 px-4 py-2 rounded-md transition-colors disabled:opacity-50",children:[e.jsx(Y,{className:"h-4 w-4"})," ",i?"Follow prompts...":"Add a new passkey"]})]}):e.jsx("p",{className:"text-sm text-yellow-600 bg-yellow-50 p-3 rounded-md",children:"Your browser or device does not support passkeys (WebAuthn)."})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 flex flex-col",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Password"}),e.jsx("div",{className:"flex-grow mt-2 text-gray-600 dark:text-gray-400",children:f?e.jsx("p",{children:"Change the password for your account."}):e.jsx("p",{children:"Your account was created using a social provider. You can create a password to enable email & password sign-in."})}),e.jsx("div",{className:"mt-4 text-right",children:e.jsx("button",{onClick:()=>u(!0),className:"text-sm font-semibold text-brand-red hover:underline",children:f?"Change":"Create"})})]}),e.jsxs("div",{className:"bg-white dark:bg-surface-dark p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-800 flex flex-col",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 dark:text-gray-100",children:"Two factor authentication"}),e.jsxs("div",{className:"flex-grow mt-2 text-gray-600 dark:text-gray-400",children:[e.jsx("p",{className:"text-sm",children:"Improve your account security by requiring a second verification step at sign-in."}),e.jsxs("p",{className:"mt-2 text-sm",children:["Status:",e.jsx("span",{className:`font-bold ml-2 ${a?.twoFactorEnabled?"text-green-600 dark:text-green-400":"text-gray-500"}`,children:a?.twoFactorEnabled?"enabled":"disabled"})]})]}),e.jsx("div",{className:"mt-4 text-right",children:a?.twoFactorEnabled?e.jsx("button",{onClick:A,disabled:h,className:"text-sm font-semibold text-brand-red hover:underline disabled:opacity-50",children:h?"Disabling...":"Disable"}):e.jsx("button",{onClick:()=>g(!0),className:"text-sm font-semibold text-brand-red hover:underline",children:"Enable"})})]})]})]}),e.jsx(Q,{isOpen:C,onClose:()=>u(!1)}),e.jsx(V,{isOpen:S,onClose:()=>g(!1)})]})};export{W as default};
